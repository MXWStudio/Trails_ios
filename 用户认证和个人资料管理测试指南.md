# 用户认证和个人资料管理测试指南

## 🎯 测试目标
验证用户登录后能够正确链接到Supabase的profiles数据表，实现完整的个人资料管理功能。

## 📋 测试前准备

### 1. 数据库设置
在Supabase控制台执行以下SQL脚本：

```sql
-- 执行 profiles_table_complete.sql 脚本
-- 这将创建完整的profiles表结构和相关触发器
```

### 2. 检查Supabase配置
确保 `SupabaseManager.swift` 中的URL和API密钥正确配置。

## 🧪 测试步骤

### 测试1：新用户注册和登录
1. **启动应用**
   - 应用应该显示登录界面
   - 检查控制台日志，确认Supabase连接正常

2. **使用Email注册新用户**
   - 点击"使用邮箱登录"按钮
   - 选择"注册"模式
   - 输入有效的邮箱地址和密码
   - 点击"注册"

3. **验证自动创建个人资料**
   - 登录成功后，应用应该自动创建用户资料
   - 检查控制台日志，确认以下信息：
     ```
     ✅ 用户登录成功，准备获取/创建个人资料...
     👤 当前用户ID: [用户UUID]
     ⚠️ 云端没有找到用户资料，准备创建新资料...
     ✅ 本地用户资料已创建
     ✅ 用户资料已同步到云端
     ```

4. **检查数据库**
   - 在Supabase控制台的profiles表中查看新创建的用户记录
   - 确认所有字段都有正确的默认值

### 测试2：现有用户登录
1. **使用已注册的邮箱登录**
   - 点击"使用邮箱登录"按钮
   - 选择"登录"模式
   - 输入已注册的邮箱和密码
   - 点击"登录"

2. **验证个人资料加载**
   - 登录成功后，应用应该从云端加载现有个人资料
   - 检查控制台日志，确认以下信息：
     ```
     ✅ 用户登录成功，准备获取/创建个人资料...
     👤 当前用户ID: [用户UUID]
     ✅ 成功从云端获取用户个人资料
     ```

3. **检查个人页面**
   - 进入个人页面，确认显示正确的用户信息
   - 验证头像、姓名、年龄等数据正确显示

### 测试3：个人资料编辑和云端同步
1. **进入编辑个人资料页面**
   - 在个人页面点击"编辑"按钮
   - 进入EditProfileView

2. **修改个人信息**
   - 更改昵称
   - 设置年龄
   - 设置身高和体重
   - 添加个人称号
   - 选择喜欢的运动类型

3. **上传头像**
   - 点击"选择照片"按钮
   - 从相册选择一张图片
   - 确认头像预览正常显示

4. **保存更改**
   - 点击"保存"按钮
   - 检查控制台日志，确认以下信息：
     ```
     📝 开始更新个人资料...
     ✅ 头像已上传到云端: [头像URL]
     💾 正在将本地用户资料同步到 Supabase...
     ✅ 用户资料成功同步到云端！
     ✅ 个人资料更新完成
     ```

5. **验证云端同步**
   - 在Supabase控制台查看profiles表
   - 确认用户记录已更新
   - 检查avatar_url字段是否包含新上传的头像URL

### 测试4：数据持久化
1. **关闭应用**
   - 完全关闭应用（从后台移除）

2. **重新启动应用**
   - 重新打开应用
   - 应用应该自动登录（如果会话有效）

3. **验证数据保留**
   - 进入个人页面
   - 确认所有编辑过的信息都正确显示
   - 确认头像正常显示

### 测试5：多设备同步
1. **在另一个设备上登录**
   - 使用相同的邮箱和密码在另一个设备上登录
   - 确认个人资料数据同步正确

2. **修改数据并同步**
   - 在一个设备上修改个人资料
   - 在另一个设备上刷新，确认数据同步

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 用户资料创建失败
**症状**: 控制台显示"用户资料云端同步失败"
**解决方案**:
- 检查是否执行了 `profiles_table_complete.sql` 脚本
- 确认Supabase连接配置正确
- 检查网络连接

#### 2. 头像上传失败
**症状**: 控制台显示"头像上传失败"
**解决方案**:
- 确认Supabase Storage已启用
- 检查avatars存储桶是否存在
- 确认存储桶权限设置正确

#### 3. 数据不同步
**症状**: 修改后的数据没有保存到云端
**解决方案**:
- 检查网络连接
- 查看控制台错误日志
- 确认数据库表结构完整

#### 4. 登录后显示空白个人资料
**症状**: 登录成功但个人页面显示空白
**解决方案**:
- 检查UserDataViewModel的handleUserLogin方法
- 确认数据库中有对应的用户记录
- 检查数据模型字段映射

## 📊 预期结果

### 成功指标
- ✅ 新用户注册后自动创建个人资料
- ✅ 现有用户登录后正确加载个人资料
- ✅ 个人资料编辑后实时同步到云端
- ✅ 头像上传功能正常工作
- ✅ 数据在应用重启后正确保留
- ✅ 多设备间数据同步正常

### 性能指标
- 登录响应时间 < 3秒
- 个人资料加载时间 < 2秒
- 头像上传时间 < 5秒
- 数据同步延迟 < 1秒

## 🎉 测试完成

如果所有测试都通过，说明用户认证和个人资料管理系统已经正常工作。用户可以：

1. 安全地注册和登录
2. 自动获得个人资料
3. 编辑和更新个人信息
4. 上传和管理头像
5. 享受跨设备的数据同步

这个系统为Trails应用提供了完整的用户管理基础，支持后续的社交功能、运动数据追踪等功能扩展。
